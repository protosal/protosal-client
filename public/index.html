<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8"/>
        <title>protosal - where your dreams come true</title>
        <link REL="shortcut icon" HREF="http://protosal.com/favicon.ico" type="image/x-icon">
    
        <script type="text/javascript" src="/media/js/script.js"></script>
        <link rel="stylesheet" type="text/css" href="/media/css/style.css"> 
        <link rel="stylesheet" type="text/css" href="/media/css/demo_page.css"> 
        <link rel="stylesheet" type="text/css" href="/media/css/demo_table.css"> 
        <link rel="stylesheet" type="text/css" href="/media/css/jgrowl.css""> 
        <link rel="stylesheet" type="text/css" href="/media/css/jquery-ui/Aristo/css/Aristo/jquery-ui-1.8.7.custom.css"> 
        <script type="text/javascript">
        cked = "";
        var GLOBALS = {
            "route_id": null,
            "controller": null,
            "action": null,
            "server_base": "http://localhost:3000",
            "couch_server": "http://localhost:3000",
            "session": false,
        };
        ckeditor_options = {  
                toolbar: [
                    ['Bold', 'Italic', '-', 'NumberedList', 'BulletedList', '-', 'Link', 'Unlink','-','About'],['Styles','Format','Font','FontSize'],
                    ['TextColor','BGColor'],
                    ['Maximize', 'ShowBlocks','-','About','Source']
                ]
            };
        if(window.location.pathname != "/") window.location = "/"; //handles 404 errors
        
        // Dynamically load CSS files.
        $script([
            'http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js',
            '/media/js/underscore.js'
            ],function(){
                $script([
                '/media/js/jquery/plugins/ryth/rythjsthtml.js',
                '/media/js/common.js',
                'https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js',
                '/media/js/backbone.js',
                '/media/js/jgrowl.min.js',
                '/media/js/jquery/plugins/ryth/rythbutton.js'
                ],
            
             function(){
                loadMain();
                $script([
                    '/media/highchart/js/highcharts.js',
                    '/media/ckeditor/ckeditor.js',
                    '/media/js/jquery.json-2.2.min.js',
                    '/media/js/jquery.defaultvalue.js',
                    '/media/js/jquery.dataTables.js',
                ], function(){ 
                    $script('/media/ckeditor/adapters/jquery.js', function(){})
        })
        })
        });
        
       function loadMain() {
            console.log("Head.js has finished loading");
            

            
            d = new Date();
            $.ajax({ 
                url: "media/templates/all.jst?" +   d.getTime(),
                success: function(response){
                        console.log("tempplates loaded, appending to dom");
                        $("body").append(response);
                        
                         $.ajaxPrefilter(function( options ) {
                          
                           options.error = function(data){
                                if( typeof $.parseJSON( data.responseText ).redirect != "undefined" ) {
                                    redirect( $.parseJSON( data.responseText ).redirect );
                                }
                           }
                        });
                        var url = GLOBALS.server_base + "/list_by_author/" + "proposal";
                        $.ajax( url, {
                            dataType: "json",
                            complete: function(headers){
                                if( headers.status != 401 ){
                                    GLOBALS.session = true;
                                    console.log("User already logged in");
                                }
                                    $.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
                                        jqXHR.error (function() {
                                            $.jGrowl("Something went wrong! Refresh the page if it continues to happen",{  theme: 'apple', position: "top-right"});
                                        });
                                    });
                                    protosal_controller = new ProtosalController;
                                    Backbone.history.start();
                                    
                            }
                        
                        });
                        
                        
                       
            
                     
                }
            });
            
            var ProtosalController = Backbone.Controller.extend({
            
              routes: {
                "/:controller/:action":                 "defaultRoute",
                "/:controller/:action/:vid":                 "defaultRoute",
                "/logout":                 "logout",
                "":                                     "landingPage",
              },
                logout: function(){
                
                    $.ajax({
                        url: "/logout",
                        dataType: "json",
                        success: function(data){
                            GLOBALS.session = false;
                            redirect(data.redirect);
                        }
                    });
                },
                landingPage: function(){
                  window.location = "#/dashboard/login"
                },
              defaultRoute: function(controller, action, vid) {
                    /* Redirect people to the home page if they try
                       to access the login page when they are already
                       authenticated.
                    */
                    if( GLOBALS.session && controller == "dashboard" && action == "login" ) {
                        redirect("dashboard/home");
                        return;
                    }

                    if( GLOBALS.session || action == "login") {
                        if( vid == null) vid = "";
                        GLOBALS.controller = controller;
                        GLOBALS.action = action;
                        GLOBALS.route_id = vid;

                        $('.maintabs li').removeClass('ui-state-active').removeClass('ui-tabs-selected'); //Make all tabs inactive
                        $("#" + GLOBALS.controller).addClass('ui-state-active').addClass('ui-tabs-selected');
                        $("#contentpane div").fadeOut(300);
                        //get URL for the ajax call
                        url = GLOBALS.server_base + "/api/get" + location.hash.substr(1) + "/" + GLOBALS.route_id; 
                        
                        //We know the page is about to change so lets clean up any jckeditors hanging around before the dom changes and jckeditors internal reference is updated
                        //CLEAN UP EVERYTHING
                        $(".jckeditor").each( function(){
                            $(this).ckeditor(function(){ // a hack to make jck editor work on page refresh
                            
                                this.destroy();
                            });
                        });
                        $(".ui-dialog").remove();
                        $(".modal_window").remove();
                        
                        var obj = {};
                        template = GLOBALS.controller + "_" + GLOBALS.action + "_view";

                        
                        var template_name = "";
                        obj.controller = GLOBALS.controller;
                        obj.action = GLOBALS.action;
                        if ( GLOBALS.action == "list" ) {
                            template_name = "common_list";
                        } else if( GLOBALS.action == "edit" ) {
                            template_name = "common_edit";
                        } else {
                            template_name = GLOBALS.controller + "_" + GLOBALS.action
                            $("#contentpane").hide();
                        }
                        if( GLOBALS.controller + GLOBALS.action == "proposaledit"){
                            $(".footer").hide();
                            $(".maincontainer").css("position", "fixed");
                            $(".containerspace").show();
                        } else {
                            $(".footer").show();
                            $(".maincontainer").css("position", "absolute");
                            $(".proposalcontainer").remove();
                            $(".containerspace").hide();
                        }

                        
                        _.jstTemplate( $("#contentpane"), $("#" + template_name + "_view_template"), obj )
                       $("#contentpane").fadeIn(300);
                    } else {
                        redirect("dashboard/login");
                    }
              }, //end of DEFAULT ROUTE

            });
            
            $(".back-button").live("click", function() { history.go(-1); return false; });
            $(".close-button").live("click", function() { $(".ui-dialog-content").dialog("close"); return false; });
            window.saveclickHandler =  function(event){

                formdata = null;

                //Serialize the form associated with the save button
                savebutton = event.currentTarget;
                savebuttoncontroller = $(savebutton).attr("controller");
                formdata = $(".edit_" + savebuttoncontroller + "_form").serializeObject();
                
                formdata.type = savebuttoncontroller;
                if(event.data.templateid == "") {
                    formdata.template    = true;
                }
                var url = GLOBALS.couch_server + "/data";
                type = "POST";
                
                // Detect if we are inserting (POST), or updating (PUT)
                // based on whether an id is supplied.
                // NB: This is only our convention, as you can insert
                // into CouchDB with PUT.
                if( typeof event.data._id != "undefined" && event.data._id != "" ) {
                    url += "/" + event.data._id; 
                    if(  event.data._rev != "" ) {
                        formdata._rev = event.data._rev;
                    }
                    type = "PUT";
                }
               
                // Do the request and on success call custom success function
                $.ajax( url, {
                    dataType: "json",
                    type: type,
                    contentType: "application/json",
                    data: $.toJSON(formdata),
                    success: function(data){
                        _.extend( data, formdata );
						console.log(event.data.success)
                        event.data.success(data);
                    }
                });
                
                return false;
            };
            
            window.Document = Backbone.Model.extend({
                url: function(){
                    var base = "data";
                    if (this.isNew()) return base;
                    rev = '';
                    if( typeof this.get("value")._rev != "undefined" ) {
                        rev = "/" + this.get("value")._rev;
                    } else {
                        rev = '';
                    }
                    return base + (base.charAt(base.length - 1) == '/' ? '' : '/') + this.id + rev;
                }
            });  
            
            $(".preview_buttons button").button();             
        };
        

    </script>
    </head>

    <body>
    
        <div class="maincontainer container">
            <div id="layout" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
                <div style="clear:both;"></div>
                <ul style="position: relative; padding-top: 15px;" class="maintabs ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
                    <a class="logo" href="/" border="0"><img src="/media/images/logo.png"></a>
                    <li style="margin-lefT: 300px;" id="dashboard" class="ui-state-default ui-corner-top  ui-state-active ui-tabs-selected"><a href="#/dashboard/home">Dashboard</a></li>
                    <li id="proposal" class="ui-state-default ui-corner-top"><a href="#/proposal/list">Proposals</a></li>
                    <li id="section" class="ui-state-default ui-corner-top"><a href="#/section/list">Sections</a></li>
                    <li id="fee" class="ui-state-default ui-corner-top"><a href="#/fee/list">Fees</a></li>
                    <li id="client" class="ui-state-default ui-corner-top"><a href="#/client/list">Clients</a></li>
                    <li id="settings" class="ui-state-default ui-corner-top"><a href="#/user/edit">Settings</a></li>
                    <div style="float: right; margin-right: 30px; margin-top: 8px;"><a href="#/test/page" style="float: left; width: 20px; margin-right: 7px;"><img style="margin-top: -1px;width: 20px;" src="/media/icons/Help-icon .png" /></a> | <a style="padding-top: 6px;" href="#/logout">logout</a></div>
                </ul>
            </div> <!-- #layout -->

            <div class="" id="contentcontainer">

                <!-- This is where the magic happens. Basically everything the user mainpulates resides in here. -->
                <div id="contentpane">
                    <div style="text-align: center; height: 300px;" id="loadingbarpage"> <!-- loading bar -->
                        <div class='loading' style="width: 32px; margin:auto; margin-top: 100px;"> </div>
                    </div>                
                </div> <!--  #contentpane -->
                
                <div style="clear:both;"></div>

            </div> <!--  #contentcontainer -->
            <div class="footer" style="text-align: center; padding-top: 40px;padding-bottom: 5px; color: #555;">
            &copy;2010–2011 Protosal, Inc. | Version 2.1
            </div>
        </div> <!-- #Container  -->
        <div class="containerspace" style="display:none;">
          
        </div>
        

    </body>    
</html>      
