<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8"/>
        <title>protosal - where your dreams come true</title>
        <link REL="shortcut icon" HREF="http://protosal.com/favicon.ico" type="image/x-icon">
    
        <script type="text/javascript" src="http://ajax.cdnjs.com/ajax/libs/headjs/0.9/head.load.min.js"></script>
         
        <script type="text/javascript">
        cked = "";
        var GLOBALS = {
            "route_id": null,
            "controller": null,
            "action": null,
            "server_base": "http://localhost:3000",
            "couch_server": "http://localhost:3000",
        };
        ckeditor_options = {  
                toolbar: [
                    ['Bold', 'Italic', '-', 'NumberedList', 'BulletedList', '-', 'Link', 'Unlink','-','About'],['Styles','Format','Font','FontSize'],
                    ['TextColor','BGColor'],
                    ['Maximize', 'ShowBlocks','-','About']
                ]
            };
        if(window.location.pathname != "/") window.location = "/"; //handles 404 errors
        
        // Dynamically load CSS files.
        head.css = function() {
            for(i = 0; i < arguments.length; i++) {
                var fileref=document.createElement("link");
                fileref.setAttribute("rel", "stylesheet");
                fileref.setAttribute("type", "text/css");
                fileref.setAttribute("href", GLOBALS.server_base + arguments[i]);
                document.getElementsByTagName("head")[0].appendChild(fileref);
            }
        }
        
        head.css(
            "/media/css/style.css",
            "/media/css/demo_page.css",
            "/media/css/demo_table.css",
            "/media/css/jgrowl.css",
            "/media/css/jquery-ui/Aristo/css/Aristo/jquery-ui-1.8.7.custom.css"
        );
        
        head.js( 
            "http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js",
            "https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js",
            GLOBALS.server_base + "/media/highchart/js/highcharts.js",
            GLOBALS.server_base + "/media/highchart/js/modules/exporting.js",
            GLOBALS.server_base + "/media/ckeditor/ckeditor.js",
            GLOBALS.server_base + "/media/ckeditor/adapters/jquery.js",
            GLOBALS.server_base + "/media/js/underscore.js",
            GLOBALS.server_base + "/media/js/backbone.js",
            GLOBALS.server_base + "/media/js/common.js",
            GLOBALS.server_base + "/media/js/jgrowl.min.js",
            GLOBALS.server_base + "/media/js/jquery.json-2.2.min.js",
            GLOBALS.server_base + "/media/js/jquery.defaultvalue.js",
            GLOBALS.server_base + "/media/js/jquery.dataTables.js",
            GLOBALS.server_base + "/media/js/jquery/plugins/ryth/rythjsthtml.js",
            GLOBALS.server_base + "/media/js/jquery/plugins/ryth/rythbutton.js"
            //GLOBALS.server_base + "/_utils/script/sha1.js",
            //GLOBALS.server_base + "/_utils/script/json2.js",
            //GLOBALS.server_base + "/_utils/script/jquery.couch.js"
        );


       head.ready(function() {
           
            
            var ProtosalController = Backbone.Controller.extend({
            
              routes: {
                "/:controller/:action":                 "defaultRoute",
                "/:controller/:action/:vid":                 "defaultRoute",
                "/logout":                 "logout",
                "":                                     "landingPage",
              },
                logout: function(){
                
                    $.ajax({
                        url: "/logout",
                        dataType: "json",
                        success: function(data){
                            redirect(data.redirect);
                        }
                    });
                },
                landingPage: function(){
                  window.location = "#/home/dashboard"
                },
              defaultRoute: function(controller, action, vid) {
                    if( vid == null) vid = "";
                    GLOBALS.controller = controller;
                    GLOBALS.action = action;
                    GLOBALS.route_id = vid;

                    $('.maintabs li').removeClass('ui-state-active').removeClass('ui-tabs-selected'); //Make all tabs inactive
                    $("#" + GLOBALS.controller).addClass('ui-state-active').addClass('ui-tabs-selected');
                
                    //get URL for the ajax call
                    url = GLOBALS.server_base + "/api/get" + location.hash.substr(1) + "/" + GLOBALS.route_id; 
                    
                    //We know the page is about to change so lets clean up any jckeditors hanging around before the dom changes and jckeditors internal reference is updated
                    
					$(".jckeditor").each( function(){
						$(this).ckeditor(function(){ // a hack to make jck editor work on page refresh
						
							this.destroy();
						});
                    });
                    
                    
                    var obj = {};
                    template = GLOBALS.controller + "_" + GLOBALS.action + "_view";

                    
                    var template_name = "";
                    obj.controller = GLOBALS.controller;
                    obj.action = GLOBALS.action;
                    if ( GLOBALS.action == "list" ) {
                        template_name = "common_list";
                    } else if( GLOBALS.action == "edit" ) {
                        template_name = "common_edit";
                    } else {
                        template_name = GLOBALS.controller + "_" + GLOBALS.action
                    }
                    
                    _.jstTemplate( $("#contentpane"), $("#" + template_name + "_view_template"), obj )
                    
              }, //end of DEFAULT ROUTE

            });
            
            $(".back-button").live("click", function() { history.go(-1); return false; });
            d = new Date();
            $.ajax({ 
                url: "media/templates/all.jst?" +   d.getTime(),
                success: function(response){
                        $("body").append(response);
                        
                         $.ajaxPrefilter(function( options ) {
                          
                           options.error = function(data){
                                if( typeof $.parseJSON( data.responseText ).redirect != "undefined" ) {
                                    redirect( $.parseJSON( data.responseText ).redirect );
                                }
                           }
                        });
                       protosal_controller = new ProtosalController;
                       Backbone.history.start();
                }
            });
            window.saveclickHandler =  function(event){

                formdata = null;

                //Serialize the form associated with the save button
                savebutton = event.currentTarget;
                savebuttoncontroller = $(savebutton).attr("controller");
                formdata = $(".edit_" + savebuttoncontroller + "_form").serializeObject();
                
                formdata.type = savebuttoncontroller;
                
                var url = GLOBALS.couch_server + "/data";
                type = "POST";
                
                // Detect if we are inserting (POST), or updating (PUT)
                // based on whether an id is supplied.
                // NB: This is only our convention, as you can insert
                // into CouchDB with PUT.
                if( typeof event.data._id != "undefined" && event.data._id != "" ) {
                    url += "/" + event.data._id; 
                    if(  event.data._rev != "" ) {
                        formdata._rev = event.data._rev;
                    }
                    type = "PUT";
                }
               
                // Do the request and on success call custom success function
                $.ajax( url, {
                    dataType: "json",
                    type: type,
                    contentType: "application/json",
                    data: $.toJSON(formdata),
                    success: function(data){
                        _.extend( data, formdata );
						
                        event.data.success(data);
                    }
                });
                
                return false;
            };
            
            window.Document = Backbone.Model.extend({
                url: function(){
                    var base = "data";
                    if (this.isNew()) return base;
                    rev = '';
                    if( typeof this.get("value")._rev != "undefined" ) {
                        rev = "/" + this.get("value")._rev;
                    } else {
                        rev = '';
                    }
                    return base + (base.charAt(base.length - 1) == '/' ? '' : '/') + this.id + rev;
                }
            });   
        });
        

    </script>
    </head>

    <body>
    
        <div class="container">
            <div id="layout" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
                <div style="clear:both;"></div>
                <ul style="position: relative; padding-top: 15px;" class="maintabs ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
                    <a class="logo" href="/" border="0"></a>
                    <li style="margin-lefT: 300px;" id="dashboard" class="ui-state-default ui-corner-top"><a href="#/dashboard/home">Dashboard</a></li>
                    <li id="proposal" class="ui-state-default ui-corner-top"><a href="#/proposal/list">Proposals</a></li>
                    <li id="section" class="ui-state-default ui-corner-top"><a href="#/section/list">Sections</a></li>
                    <li id="fee" class="ui-state-default ui-corner-top"><a href="#/fee/list">Fees</a></li>
                    <li id="client" class="ui-state-default ui-corner-top"><a href="#/client/list">Clients</a></li>
                    <li id="setting" class="ui-state-default ui-corner-top"><a href="#/setting/main">Settings</a></li>
                    <div style="float: right; margin-right: 24px; margin-top: 10px;"><a href="#/test/page">help</a> | <a href="#/logout">logout</a></div>
                </ul>
            </div> <!-- #layout -->

            <div class="" id="contentcontainer">

                <!-- This is where the magic happens. Basically everything the user mainpulates resides in here. -->
                <div id="contentpane">

                </div> <!--  #contentpane -->
                
                <div style="clear:both;"></div>

            </div> <!--  #contentcontainer -->
            <div style="text-align: center; padding-top: 40px;padding-bottom: 5px; color: #555;">
            &copy;2010–2011 Protosal, Inc. | Version 2.1
            </div>
        </div> <!-- #Container  -->
        
        
        <div style="display: none;" id="loadingbarpage"> <!-- loading bar -->
            <div class='loading' style="text-align: center; padding-top: 200px;"> </div>
        </div>
    </body>    
</html>      
